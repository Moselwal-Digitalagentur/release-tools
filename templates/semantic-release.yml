spec:
  inputs:
    stage:
      default: 'release'
---
release:semver:
  image: node:20-alpine3.19
  stage: $[[ inputs.stage ]]
  variables:
    GIT_SUBMODULE_STRATEGY: recursive
    GIT_SUBMODULE_DEPTH: 1
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_REF_NAME != null && $CI_COMMIT_TAG == null && $CI_PIPELINE_SOURCE != "schedule"
  before_script:
    - apk add --no-cache git openssh gnupg jq
  script:
    - git config --local user.email ${GITLAB_USER_EMAIL}
    - git config --local user.name "${GITLAB_USER_NAME}"
    #- gpg --batch --yes --import ${GPG_SEM_REL}
    #- git config --global user.signingkey ${GPG_ID_SEM_REL}
    #- git config --local commit.gpgsign true
    - export GIT_AUTHOR_NAME=${GITLAB_USER_NAME}
    - export GIT_AUTHOR_EMAIL=${GITLAB_USER_EMAIL}
    - export GIT_COMMITTER_NAME=${GITLAB_USER_NAME}
    - export GIT_COMMITTER_EMAIL=${GITLAB_USER_EMAIL}

    - npm install @semantic-release/gitlab
    - npm install conventional-changelog-conventionalcommits
    - npx semantic-release

